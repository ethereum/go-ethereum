name: Deploy Hardhat Project to Devnet and Save Image

on:
  pull_request:
    types: [closed]
    branches:
      - master

jobs:
  deploy-hardhat:
    if: github.event.pull_request.merged == true && contains(github.event.pull_request.labels.*.name, 'CI:Deploy')
    runs-on: ubuntu-latest

    env:
      BASE_IMAGE: yohands/my_first_container:latest
      FINAL_IMAGE: yohands/my_first-contracts
      CONTAINER_NAME: devnet-node

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

        # capture SHA as an env variables  
      - name: Get short commit SHA
        id: vars
        run: echo "COMMIT_SHA=$(echo $GITHUB_SHA | cut -c1-7)" >> $GITHUB_ENV        

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Start devnet with go-ethereum image
        run: |
          docker run -d \
            --name $CONTAINER_NAME \
            -p 8545:8545 \
            $BASE_IMAGE \
            --dev --http --http.addr 0.0.0.0 --http.vhosts "*" --http.api eth,net,web3,personal

            
#      - name: check if curl is installed
#        run: docker exec $CONTAINER_NAME which curl             
    #   - name: Wait for Geth RPC to become available
    #     run: |
    #       echo "Waiting for Geth RPC to be ready..."
    #       for i in {1..30}; do
    #         if docker exec $CONTAINER_NAME curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8545 > /dev/null; then
    #           echo "Geth RPC is up!"
    #           break
    #         fi
    #         echo "Attempt $i: Not yet ready..."
    #         sleep 2
    #       done

    #       if ! docker exec $CONTAINER_NAME curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8545 > /dev/null; then
    #         echo "âŒ Geth RPC did not start within 60 seconds."
    #         echo "--- Container logs ---"
    #         docker logs $CONTAINER_NAME
    #         echo "--- Container status ---"
    #         docker ps -a
    #         exit 1
    #       fi

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install Hardhat dependencies
        working-directory: ./hardhat
        run: npm install

      - name: Deploy contracts to devnet
        working-directory: ./hardhat
        run: npx hardhat run scripts/deploy.js --network localhost

      - name: Commit container with deployed contracts
        run: |
          docker commit $CONTAINER_NAME $FINAL_IMAGE:latest
          docker tag $FINAL_IMAGE:latest $FINAL_IMAGE:${{ env.COMMIT_SHA }}

      - name: Stop and remove container
        run: docker rm -f $CONTAINER_NAME        

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Push image to Docker Hub
        run: |
          docker push $FINAL_IMAGE:latest
          docker push $FINAL_IMAGE:${{ env.COMMIT_SHA }}
  
      - name: Run container with predeployed contracts
        run: |
          docker run -d \
            --name test-node \
            -p 8545:8545 \
            $FINAL_IMAGE:latest \
            --dev --http --http.addr 0.0.0.0 --http.vhosts "*" --http.api eth,net,web3,personal
            sleep 20

      # - name: Wait for RPC to be ready
      #   run: |
      #     echo "Waiting for devnet to be ready..."
      #     for i in {1..20}; do
      #       if curl -s http://localhost:8545 > /dev/null; then
      #         echo "RPC is ready."
      #         break
      #       fi
      #       sleep 2
      #     done

      - name: Run Hardhat tests
        working-directory: ./hardhat
        run: npx hardhat test # --network localhost

      - name: Stop and remove test container
        run: docker rm -f test-node          